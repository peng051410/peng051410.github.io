<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringMVC实践之集成Sentinel限流功能 | I'm company</title><meta name=keywords content="spring,springmvc"><meta name=description content="背景
近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务
Sentinel前置知识
Sentinel 限流主要涉及以下几方面
Resource
限流的资源，资源支持动态加载，核心类为： AbstractDataSource ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现

Rule
对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 FlowSlot

     


FlowSlot 的功能实现需要依赖前面的 NodeSelectorSlot 和 ClusterBuilderSlot 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图

各Slot默认的顺序也可以在代码中找到

核心处理逻辑
核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作

     


集成步骤
借助SpringMVC中提供的 HandlerInterceptor 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能
引入Sentinel SpringMVC Adapter
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-spring-webmvc-adapter</artifactId>
    <version>1.8.8</version>
</dependency>
配置SentinelWebInterceptor
Sentinel  SpringMVC Adapter中提供了 SentinelWebInterceptor 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现
SentinelWebMvcConfig 常用配置说明
SentinelWebMvcConfig 支持以下配置能力


urlCleaner

         
    

自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX




httpMethodSpecify
是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果:  GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX




blockExceptionHandler

被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 ExceptionHandler 进行统一处理




originParser

请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin"><meta name=author content="tomyli"><link rel=canonical href=http://blog.imcompany.cn/post/spring-webmvc-interceptor/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://blog.imcompany.cn/post/spring-webmvc-interceptor/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://blog.imcompany.cn/post/spring-webmvc-interceptor/"><meta property="og:site_name" content="I'm company"><meta property="og:title" content="SpringMVC实践之集成Sentinel限流功能"><meta property="og:description" content="背景 近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务
Sentinel前置知识 Sentinel 限流主要涉及以下几方面
Resource 限流的资源，资源支持动态加载，核心类为： AbstractDataSource ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现 Rule 对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 FlowSlot
FlowSlot 的功能实现需要依赖前面的 NodeSelectorSlot 和 ClusterBuilderSlot 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图 各Slot默认的顺序也可以在代码中找到 核心处理逻辑 核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作
集成步骤 借助SpringMVC中提供的 HandlerInterceptor 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能
引入Sentinel SpringMVC Adapter <dependency> <groupId>com.alibaba.csp</groupId> <artifactId>sentinel-spring-webmvc-adapter</artifactId> <version>1.8.8</version> </dependency> 配置SentinelWebInterceptor Sentinel SpringMVC Adapter中提供了 SentinelWebInterceptor 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现
SentinelWebMvcConfig 常用配置说明 SentinelWebMvcConfig 支持以下配置能力
urlCleaner
自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX
httpMethodSpecify
是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果: GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX
blockExceptionHandler
被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 ExceptionHandler 进行统一处理
originParser
请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-04-25T17:53:54+08:00"><meta property="article:modified_time" content="2025-04-25T17:53:54+08:00"><meta property="article:tag" content="Spring"><meta property="article:tag" content="Springmvc"><meta property="og:image" content="http://blog.imcompany.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.imcompany.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="SpringMVC实践之集成Sentinel限流功能"><meta name=twitter:description content="背景
近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务
Sentinel前置知识
Sentinel 限流主要涉及以下几方面
Resource
限流的资源，资源支持动态加载，核心类为： AbstractDataSource ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现

Rule
对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 FlowSlot

     


FlowSlot 的功能实现需要依赖前面的 NodeSelectorSlot 和 ClusterBuilderSlot 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图

各Slot默认的顺序也可以在代码中找到

核心处理逻辑
核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作

     


集成步骤
借助SpringMVC中提供的 HandlerInterceptor 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能
引入Sentinel SpringMVC Adapter
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-spring-webmvc-adapter</artifactId>
    <version>1.8.8</version>
</dependency>
配置SentinelWebInterceptor
Sentinel  SpringMVC Adapter中提供了 SentinelWebInterceptor 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现
SentinelWebMvcConfig 常用配置说明
SentinelWebMvcConfig 支持以下配置能力


urlCleaner

         
    

自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX




httpMethodSpecify
是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果:  GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX




blockExceptionHandler

被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 ExceptionHandler 进行统一处理




originParser

请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://blog.imcompany.cn/post/"},{"@type":"ListItem","position":2,"name":"SpringMVC实践之集成Sentinel限流功能","item":"http://blog.imcompany.cn/post/spring-webmvc-interceptor/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringMVC实践之集成Sentinel限流功能","name":"SpringMVC实践之集成Sentinel限流功能","description":"背景 近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务\nSentinel前置知识 Sentinel 限流主要涉及以下几方面\nResource 限流的资源，资源支持动态加载，核心类为： AbstractDataSource ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现 Rule 对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 FlowSlot\nFlowSlot 的功能实现需要依赖前面的 NodeSelectorSlot 和 ClusterBuilderSlot 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图 各Slot默认的顺序也可以在代码中找到 核心处理逻辑 核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作\n集成步骤 借助SpringMVC中提供的 HandlerInterceptor 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能\n引入Sentinel SpringMVC Adapter \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba.csp\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;sentinel-spring-webmvc-adapter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.8\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 配置SentinelWebInterceptor Sentinel SpringMVC Adapter中提供了 SentinelWebInterceptor 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现\nSentinelWebMvcConfig 常用配置说明 SentinelWebMvcConfig 支持以下配置能力\nurlCleaner\n自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX\nhttpMethodSpecify\n是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果: GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX\nblockExceptionHandler\n被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 ExceptionHandler 进行统一处理\noriginParser\n请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin\n","keywords":["spring","springmvc"],"articleBody":"背景 近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务\nSentinel前置知识 Sentinel 限流主要涉及以下几方面\nResource 限流的资源，资源支持动态加载，核心类为： AbstractDataSource ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现 Rule 对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 FlowSlot\nFlowSlot 的功能实现需要依赖前面的 NodeSelectorSlot 和 ClusterBuilderSlot 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图 各Slot默认的顺序也可以在代码中找到 核心处理逻辑 核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作\n集成步骤 借助SpringMVC中提供的 HandlerInterceptor 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能\n引入Sentinel SpringMVC Adapter com.alibaba.csp sentinel-spring-webmvc-adapter 1.8.8 配置SentinelWebInterceptor Sentinel SpringMVC Adapter中提供了 SentinelWebInterceptor 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现\nSentinelWebMvcConfig 常用配置说明 SentinelWebMvcConfig 支持以下配置能力\nurlCleaner\n自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX\nhttpMethodSpecify\n是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果: GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX\nblockExceptionHandler\n被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 ExceptionHandler 进行统一处理\noriginParser\n请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin\n配置 SentinelWebMvcConfig 由于此次只需要根据用户设备维度进行限流，所以只自定义配置了 urlCleaner，代码如下： 对于BlockException统一配置ExceptionHandler实现 新增 DefaultSentinelInterceptor 为了后续能将此功能做的更通用，没有直接使用 SentinelWebInterceptor , 而是新增了 SentinelWebInterceptor 一个子类 DefaultSentinelInterceptor ，将 DefaultSentinelInterceptor 做为Spring的一个Component进行管理，这样就可以方便的把上述配置的 SentinelWebMvcConfig 进行注入\n配置 DefaultSentinelInterceptor 到 Spring的WebMvcConfigurer中 在 WebMvcConfigurer 的实现类增加 DefaultSentinelInterceptor 拦截器配置，配置其优先级为 PrepareInterceptor 后\n配置的资源在哪？ 找了一下，Peacock已经提供了基于七彩石配置的Resouce实现 RainbowSentinelDatasourceInit ，配置在 SentinelDatasourceConfiguration ，解析的是 flowRule.json 文件，配置的内容就是官方的配置风格，这样看完全可以拿来一用而不需要再实现一遍了。 来看看 flowRule.json 能配置哪些内容 再借一张官方图 基本上使用了官方提供的默认配置值即可，对于 count 值可以根据线上提供服务的机器数进行配置即可。在实现配置时增加了一个 regex 项，即支持正则匹配，这样对于厂商根据设备id的维度进行限流就可以在 resource 项直接配置一个正则就可以了，具体配置如下： strategy可配置值为 0(直接)、1(链路)、2(关联) controlBehavior可配置值为 0. 直接拒绝, 1. WarmUp, 2. 匀速, 3. 排队等待 REF https://github.com/alibaba/Sentinel/wiki\n","wordCount":"131","inLanguage":"en","image":"http://blog.imcompany.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-04-25T17:53:54+08:00","dateModified":"2025-04-25T17:53:54+08:00","author":{"@type":"Person","name":"tomyli"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.imcompany.cn/post/spring-webmvc-interceptor/"},"publisher":{"@type":"Organization","name":"I'm company","logo":{"@type":"ImageObject","url":"http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://blog.imcompany.cn/ accesskey=h title="Home (Alt + H)"><img src=http://blog.imcompany.cn/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://blog.imcompany.cn/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://blog.imcompany.cn/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://blog.imcompany.cn/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/peng051410/today_i_learn title=Til><span>Til</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://blog.imcompany.cn/>Home</a>&nbsp;»&nbsp;<a href=http://blog.imcompany.cn/post/>Posts</a></div><h1 class="post-title entry-hint-parent">SpringMVC实践之集成Sentinel限流功能</h1><div class=post-meta><span title='Created: 2025-04-25 17:53:54 +0800 CST'>2025-04-25</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>131 words</span>&nbsp;·&nbsp;<span>tomyli</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#sentinel前置知识>Sentinel前置知识</a><ul><li><a href=#resource>Resource</a></li><li><a href=#rule>Rule</a></li></ul></li><li><a href=#集成步骤>集成步骤</a><ul><li><a href=#引入sentinel-springmvc-adapter>引入Sentinel SpringMVC Adapter</a></li><li><a href=#配置sentinelwebinterceptor>配置SentinelWebInterceptor</a></li><li><a href=#配置的资源在哪>配置的资源在哪？</a></li></ul></li><li><a href=#ref>REF</a></li></ul></nav></div></details></div><div class=post-content><h2 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h2><p>近期收到线上报警，发现个别新接口在同1s内被请求了接近上百次，对系统的稳定造成了一些影响，近期调研了一下通用的限流框架，打算将Sentinel的限流功能集成进新服务</p><h2 id=sentinel前置知识>Sentinel前置知识<a hidden class=anchor aria-hidden=true href=#sentinel前置知识>#</a></h2><p>Sentinel 限流主要涉及以下几方面</p><h3 id=resource>Resource<a hidden class=anchor aria-hidden=true href=#resource>#</a></h3><p>限流的资源，资源支持动态加载，核心类为： <code>AbstractDataSource</code> ，Sentinel 默认提供了市面常见的资源管理服务的实现，也可以自定义实现
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/bMQyLZ.png></p><h3 id=rule>Rule<a hidden class=anchor aria-hidden=true href=#rule>#</a></h3><p>对定义的 Resouce 应用的限流规则，基于QPS、响应时间与系统负载。Sentinel 是通过一系列的功能Slot来实现不同的统计/控制功能，对于限流功能对应的就是 <code>FlowSlot</code></p><figure><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/DSNjeo.png></figure><p><code>FlowSlot</code> 的功能实现需要依赖前面的 <code>NodeSelectorSlot</code> 和 <code>ClusterBuilderSlot</code> 等统计Slot，有了统计信息才可以针对配置进行限流操作，这里面借用一张官方的实现图
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/3TQkqg.png></p><p>各Slot默认的顺序也可以在代码中找到
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/hZyabG.png></p><h4 id=核心处理逻辑>核心处理逻辑<a hidden class=anchor aria-hidden=true href=#核心处理逻辑>#</a></h4><p>核心逻辑是在执行调用chain的捕获Blockexcption然后执行后续操作</p><figure><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/514k2Q.png></figure><h2 id=集成步骤>集成步骤<a hidden class=anchor aria-hidden=true href=#集成步骤>#</a></h2><p>借助SpringMVC中提供的 <code>HandlerInterceptor</code> 拦截器功能 与 Sentinel 提供的SpringMVC框架集成类库可以方便快速的实现限流功能</p><h3 id=引入sentinel-springmvc-adapter>引入Sentinel SpringMVC Adapter<a hidden class=anchor aria-hidden=true href=#引入sentinel-springmvc-adapter>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.alibaba.csp<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>sentinel-spring-webmvc-adapter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.8.8<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=配置sentinelwebinterceptor>配置SentinelWebInterceptor<a hidden class=anchor aria-hidden=true href=#配置sentinelwebinterceptor>#</a></h3><p><a href=https://github.com/alibaba/Sentinel/tree/1.8/sentinel-adapter/sentinel-spring-webmvc-adapter>Sentinel SpringMVC Adapter</a>中提供了 <code>SentinelWebInterceptor</code> 来实现限流功能，这个 Interceptor 支持一些自定义的行为，主要通过 SentinelWebMvcConfig 来实现</p><h4 id=sentinelwebmvcconfig-常用配置说明>SentinelWebMvcConfig 常用配置说明<a hidden class=anchor aria-hidden=true href=#sentinelwebmvcconfig-常用配置说明>#</a></h4><p>SentinelWebMvcConfig 支持以下配置能力</p><ul><li><p>urlCleaner</p><figure><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/8I1bRn.png></figure><p>自定义对请求url的处理，比如厂商此次需要通过请求的设备id维度进行限流，对于其它的请求参数都进行忽略，最终可定义效果为: <code>/api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX</code></p></li></ul><ul><li><p>httpMethodSpecify</p><p>是否指定特定的Http请求方法，此设置是对资源的请求方法进行了细粒度的配置，默认为false不开启，配置为true后，会在设定好的资源名前加上请求的方法，类似效果: <code>GET: /api/v1/test/ping?did=6308103f1026acf274bbcc1b10001291551xxX</code></p></li></ul><ul><li><p>blockExceptionHandler</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/XluwAf.png>
被Block的请求异常处理器，对Block的请求进行自定义处理，可以设置返回的值，如果未配置则需要服务自己捕获 BlockException，可以通过配置 <code>ExceptionHandler</code> 进行统一处理</p></li></ul><ul><li><p>originParser</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/njPqHL.png>
请求来源处理器，针对请求的来源进行处理，在配置资源的规则的可以使用此解析的origin细粒度控制，例如可以解析ip、用户做为请求 origin</p></li></ul><h4 id=配置-sentinelwebmvcconfig>配置 SentinelWebMvcConfig<a hidden class=anchor aria-hidden=true href=#配置-sentinelwebmvcconfig>#</a></h4><p>由于此次只需要根据用户设备维度进行限流，所以只自定义配置了 urlCleaner，代码如下：
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/Ofue0M.png></p><p>对于BlockException统一配置ExceptionHandler实现
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/9c9KuV.png></p><h4 id=新增-defaultsentinelinterceptor>新增 DefaultSentinelInterceptor<a hidden class=anchor aria-hidden=true href=#新增-defaultsentinelinterceptor>#</a></h4><p>为了后续能将此功能做的更通用，没有直接使用 <code>SentinelWebInterceptor</code> , 而是新增了 <code>SentinelWebInterceptor</code> 一个子类 <code>DefaultSentinelInterceptor</code> ，将 <code>DefaultSentinelInterceptor</code> 做为Spring的一个Component进行管理，这样就可以方便的把上述配置的 SentinelWebMvcConfig 进行注入</p><figure><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/yhj9Gn.png></figure><h4 id=配置-defaultsentinelinterceptor-到-spring的webmvcconfigurer中>配置 DefaultSentinelInterceptor 到 Spring的WebMvcConfigurer中<a hidden class=anchor aria-hidden=true href=#配置-defaultsentinelinterceptor-到-spring的webmvcconfigurer中>#</a></h4><p>在 WebMvcConfigurer 的实现类增加 <code>DefaultSentinelInterceptor</code> 拦截器配置，配置其优先级为 PrepareInterceptor 后</p><figure><img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/HFVbgn.png></figure><h3 id=配置的资源在哪>配置的资源在哪？<a hidden class=anchor aria-hidden=true href=#配置的资源在哪>#</a></h3><p>找了一下，Peacock已经提供了基于七彩石配置的Resouce实现 <code>RainbowSentinelDatasourceInit</code> ，配置在 <code>SentinelDatasourceConfiguration</code> ，解析的是 <code>flowRule.json</code> 文件，配置的内容就是官方的配置风格，这样看完全可以拿来一用而不需要再实现一遍了。
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/H8lRJB.png></p><h4 id=来看看-flowrule-dot-json-能配置哪些内容>来看看 flowRule.json 能配置哪些内容<a hidden class=anchor aria-hidden=true href=#来看看-flowrule-dot-json-能配置哪些内容>#</a></h4><p>再借一张官方图
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/06SzPK.png></p><p>基本上使用了官方提供的默认配置值即可，对于 count 值可以根据线上提供服务的机器数进行配置即可。在实现配置时增加了一个 regex 项，即支持正则匹配，这样对于厂商根据设备id的维度进行限流就可以在 resource 项直接配置一个正则就可以了，具体配置如下：
<img loading=lazy src=https://cdn.jsdelivr.net/gh/peng051410/bucket@main/img/Yer8r9.png></p><blockquote><ol><li>strategy可配置值为 0(直接)、1(链路)、2(关联)</li><li>controlBehavior可配置值为 0. 直接拒绝, 1. WarmUp, 2. 匀速, 3. 排队等待</li></ol></blockquote><h2 id=ref>REF<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><p><a href=https://github.com/alibaba/Sentinel/wiki>https://github.com/alibaba/Sentinel/wiki</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://blog.imcompany.cn/tags/spring/>Spring</a></li><li><a href=http://blog.imcompany.cn/tags/springmvc/>Springmvc</a></li></ul><nav class=paginav><a class=prev href=http://blog.imcompany.cn/post/windows-backup/><span class=title>« Prev</span><br><span>Windows相关软件或工具</span>
</a><a class=next href=http://blog.imcompany.cn/post/peng-week15/><span class=title>Next »</span><br><span>众乐乐-weekly 第15期</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on x" href="https://x.com/intent/tweet/?text=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd&amp;url=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f&amp;hashtags=spring%2cspringmvc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f&amp;title=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd&amp;summary=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd&amp;source=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f&title=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on whatsapp" href="https://api.whatsapp.com/send?text=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd%20-%20http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on telegram" href="https://telegram.me/share/url?text=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd&amp;url=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share SpringMVC实践之集成Sentinel限流功能 on ycombinator" href="https://news.ycombinator.com/submitlink?t=SpringMVC%e5%ae%9e%e8%b7%b5%e4%b9%8b%e9%9b%86%e6%88%90Sentinel%e9%99%90%e6%b5%81%e5%8a%9f%e8%83%bd&u=http%3a%2f%2fblog.imcompany.cn%2fpost%2fspring-webmvc-interceptor%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=http://blog.imcompany.cn/>I'm company</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>