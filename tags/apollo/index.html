<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Apollo | I'm company</title><meta name=keywords content><meta name=description content="Everyone is a company."><meta name=author content="Me"><link rel=canonical href=http://blog.imcompany.cn/tags/apollo/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://blog.imcompany.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=http://blog.imcompany.cn/tags/apollo/index.xml title=rss><link rel=alternate hreflang=en href=http://blog.imcompany.cn/tags/apollo/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://blog.imcompany.cn/tags/apollo/"><meta property="og:site_name" content="I'm company"><meta property="og:title" content="Apollo"><meta property="og:description" content="Everyone is a company."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="http://blog.imcompany.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.imcompany.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Apollo"><meta name=twitter:description content="Everyone is a company."></head><body class=list id=top><header class=header><nav class=nav><div class=logo><a href=http://blog.imcompany.cn/ accesskey=h title="Home (Alt + H)"><img src=http://blog.imcompany.cn/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://blog.imcompany.cn/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://blog.imcompany.cn/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://blog.imcompany.cn/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/peng051410/today_i_learn title=Til><span>Til</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=http://blog.imcompany.cn/>Home</a>&nbsp;»&nbsp;<a href=http://blog.imcompany.cn/tags/>Tags</a></div><h1>Apollo
<a href=/tags/apollo/index.xml title=RSS aria-label=RSS><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="23"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Apollo不更新配置了？</h2></header><div class=entry-content><p>问题描述 近期改造服务调用，需要使用Apollo配置进行灵活切换，上线后发现有些机器配置生效，有些配置未生效，开发小伙伴反馈此问题发生有一段时间
问题排查 机器排查 对线上机器进行排查，发现有几台机器根本没有拉取新的应用配置
指定问题机器信息 进入到问题机器查看本地Apollo文件信息
... -rw-rw-r-- 1 mqq mqq 3429 May 19 15:32 main-webapp+default+CoopReader.baipai.switch.properties -rw-r--r-- 1 mqq mqq 1621 Jul 4 15:39 main-webapp+default+CoopReader.switcher.properties -rw-r--r-- 1 mqq mqq 89 Aug 26 11:18 main-webapp+default+CoopReader.personal.menu.properties -rw-r--r-- 1 mqq mqq 3958 Aug 26 15:45 main-webapp+default+CoopReader.common.config.propertie 可以看到文件的最新日期在8月26日
Apollo 服务的问题? 先前小伙伴反应问过运维相关问题，得到的结论是Apollo没有改动，且服务配置不是完全不可用，此方向排除
服务的问题? 从目前得到的信息可以确认是某几台机器上的Apollo client没有去拉取最新的配置信息
为什么没有拉取到最新配置? 先来梳理一下Apollo的使用流程:
业务对Apollo的访问都基于 L5 的方式 目前业务工程使用cloudlevel5.Protocol来获取L5的信息与Apollo Portal进行交互 &lt;dependency> &lt;groupId>com.yuewen&lt;/groupId> &lt;artifactId>userbase-l5-system&lt;/artifactId> &lt;version>1.0.3.Final&lt;/version> &lt;/dependency> 为什么业务机没有与Apollo portal交互? 怀疑与出问题的机器获取不到L5信息有关
问题猜测验证 大体知道问题出在哪了，下面就需要进行验证了。最简单的方式就是打印出Apollo的相关日志信息对猜测进行验证，但是目前业务的日志级别设置的 ERROR ，啥也看不到
修改业务日志级别? 现在需要打印aplllo相关的日志级别为 Info ，需要修改Logback中配置如下：
&lt;logger name="com.ctrip.framework.apollo" level="info"/> 但是还是需要发版本上线，未免太麻烦，有没有其它办法？
Arthas动态修改日志级别 现在已经有非常成熟的线上调试工具了，Arthas就能实现对Logback的动态日志修改，二话不说，直接机器上修改验证
在问题机器上启动arthas java -jar arthas-boot.jar 选择要处理的应用(10384)进入到arthas
...</p></div><footer class=entry-footer><span title='2022-09-16 15:22:00 +0800 CST'>2022-09-16</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>208 words</span>&nbsp;·&nbsp;<span>tomyli</span></footer><a class=entry-link aria-label="post link to Apollo不更新配置了？" href=http://blog.imcompany.cn/post/apollo-work-issue/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Apollo Client自定义问题拾遗</h2></header><div class=entry-content><p>由于公司很多服务要接入Apollo配置中心，并且对于项目的接入有网络要求，根据官方说明，需要自定义Client来完成
接入步骤 新建maven项目 在Idea中新建maven项目，基于quickstart构建
增加项目依赖 官方说明的建议在新的client中依赖Apollo官方的client，再根据业务进行扩展，所以maven依赖apollo-client，公司项目的网络访问需要通过L5来进行，所以还要依赖L5的jar，目前这个jar包没有maven坐标，只能以lib方式引入
自定义MetaServer 关键的部分，自定义满足公司网络条件的MetaServer，Apollo官网说明是实现MetaServerProvider且Order值小的Providor被使用，按照说明进行实现
Maven打包Client 执行 mvn clean install 进行打包，解压jar包发现就只有一个Providor的实现类，这样jar运行有问题。需要把新Client所有的依赖都打进jar包，在网上找了半天，需要在POM中增加maven的plugin的配置，如下：
&lt;!-- 打包所有的maven依赖到jar包 --> &lt;plugin> &lt;groupId>org.apache.maven.plugins&lt;/groupId> &lt;artifactId>maven-shade-plugin&lt;/artifactId> &lt;version>3.2.1&lt;/version> &lt;executions> &lt;execution> &lt;phase>package&lt;/phase> &lt;goals> &lt;goal>shade&lt;/goal> &lt;/goals> &lt;configuration> &lt;artifactSet> &lt;excludes> &lt;exclude>junit:junit&lt;/exclude> &lt;/excludes> &lt;/artifactSet> &lt;/configuration> &lt;/execution> &lt;/executions> &lt;/plugin> &lt;!-- 添加依赖的非maven jar包 --> &lt;plugin> &lt;groupId>com.googlecode.addjars-maven-plugin&lt;/groupId> &lt;artifactId>addjars-maven-plugin&lt;/artifactId> &lt;version>1.0.5&lt;/version> &lt;executions> &lt;execution> &lt;goals> &lt;goal>add-jars&lt;/goal> &lt;/goals> &lt;configuration> &lt;resources> &lt;resource> &lt;directory>${basedir}/lib&lt;/directory> &lt;/resource> &lt;/resources> &lt;/configuration> &lt;/execution> &lt;/executions> &lt;/plugin> 由于项目中使用了maven依赖与非maven依赖，所以上述的两个插件都要使用。增加了上面两个插件后再运行打包命令查看生成的jar就发现所有的依赖都在jar中了。
项目中使用Client 选择一个项目在测试环境进行配置调试，自定义的Meta Server一直没有生效，所以查找官方文档，由于自定义Providor是通过SPI方式实现的，所以正确的实现方式是新建resource文件夹，指定MetaServerProvider的真正实现类的带包名类才可以，哎，找了我好久。
后续操作 后续会把client上传到内部maven仓库，完善配置API，使业务方可以零配置来使用配置中心。
总结 Maven的打包机制还是不清晰，处理打包问题费了很多时间，要好好重新学习一下 Apollo的官方文档还需要再仔细阅读，有问题多查issue，因为可能有人已经遇到了 多读读源码，真正的体会大牛的软件设计思想</p></div><footer class=entry-footer><span title='2019-07-01 07:04:09 +0800 CST'>2019-07-01</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>70 words</span>&nbsp;·&nbsp;<span>tomyli</span></footer><a class=entry-link aria-label="post link to Apollo Client自定义问题拾遗" href=http://blog.imcompany.cn/post/apollo-client-custom/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Apollo 配置中心畅游</h2></header><div class=entry-content><p>目前市面上的开源产品 Disconf 2014年7月百度开源的配置管理中心，同样具备配置的管理能力，目前已经不维护了，最近的一次代码提交是两年前了。
Spring Cloud Config 2014年9月开源，Spring Cloud生态组件，与Spring Cloud体系无缝整合。
Apollo 2016年5月，携程框架部开源的配置管理中心，具备规范的权限、流程治理等特性。
Nacos 2018年6月，阿里开源的配置中心，可以做DNS和RPC的服务发现。
为什么选择Apollo 社区活跃 刚刚发布了1.4.0版本，Issue处理速度快
文档齐全 体验，部署，设计文档都齐全
重要的灰度发布 想发布一台机器试试水，可以！
开源协议友好 Apache 2 license
Apollo都有哪些重要功能 以下摘自官网说明
统一管理不同环境、不同集群的配置 配置修改实时生效（热发布） 版本发布管理 目前只支持对最近版本的恢复。https://github.com/ctripcorp/apollo/issues/1642
灰度发布 权限管理、发布审核、操作审计 编辑与发布是两个独立的操作。
客户端配置信息监控 提供Java和.Net原生客户端 提供开放平台API 这样可以通过其它方式来查看配置信息，平台API说明
使用方便的后台配置系统Portal 分布式部署相对较复杂，这是缺点 外部依赖少，目前依赖Mysql
Apollo的组成 Apollo长什么样? Apollo整体设计 总体架构 代码结构 各模块概要介绍
Apollo Config Service 提供配置获取接口，服务对象为Apollo客户端
Apollo Admin Service 提供配置管理（修改、发布）接口，服务与Portal
Apollo Portal 提供WEB界面供用户管理配置
Apollo的重要设计 Admin Service与Config Service的通信方式 Apollo使用Mysql实现消息(ReleaseMessage)的处理，消息内容为AppId+Cluster+Namespace，具体的设计思想可以参考这里
客户端与服务端的通信方式 客户端与服务端保持一个长连接(通过Http Long Polling实现) Client Server
重要的Namespace Namespace是配置项的集合，类似于一个配置文件的概念，获取的权限分为private与public两种权限。
Namespace的类型 私有类型 公有类型 关联类型（继承类型） Cluster能用来做什么? 分机房实例，分任务功能实例，比如在一些实例执行job，需要增加-Dapollo.cluster=配置指定集群名
...</p></div><footer class=entry-footer><span title='2019-05-09 17:34:09 +0800 CST'>2019-05-09</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>108 words</span>&nbsp;·&nbsp;<span>tomyli</span></footer><a class=entry-link aria-label="post link to Apollo 配置中心畅游" href=http://blog.imcompany.cn/post/apollo-config-swim/></a></article></main><footer class=footer><span>&copy; 2026 <a href=http://blog.imcompany.cn/>I'm company</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>